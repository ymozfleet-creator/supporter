<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MySUPPORTER | Social Share & Viral Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* 背景 */
        .bg-gradient-mesh { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; pointer-events: none; background: radial-gradient(circle at 10% 20%, rgba(30, 41, 59, 0.03) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.03) 0%, transparent 40%); }
        
        /* Campaign Card */
        .campaign-card { 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease; 
            background: #fff; 
            border: 1px solid #e2e8f0; 
            overflow: hidden; 
            border-radius: 1.25rem; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); 
            height: 100%;
        }
        .campaign-card:active { transform: scale(0.98); }
        @media(min-width: 768px) {
            .campaign-card:hover { transform: translateY(-8px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border-color: #3b82f6; }
        }
        
        /* Inputs */
        .input-field { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.75rem; padding: 1rem; width: 100%; outline: none; transition: 0.2s; font-size: 16px; font-weight: 600; color: #334155; }
        .input-field:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Progress Bar */
        .meter-bg { background: #e2e8f0; height: 8px; border-radius: 99px; overflow: hidden; position: relative; margin-top: 0.75rem; }
        .meter-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); border-radius: 99px; width: 0%; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); }
        .meter-fill.goal-reached { background: linear-gradient(90deg, #f59e0b, #fbbf24); box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
        
        /* Cool Goal Stamp */
        .goal-overlay-cool {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 20;
        }
        .goal-stamp-cool {
            border: 2px solid #fbbf24; padding: 1rem 3rem; color: #fbbf24; font-weight: 900; font-size: 1.5rem;
            text-transform: uppercase; letter-spacing: 0.3em; 
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), transparent);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.8); border-radius: 0; white-space: nowrap;
        }

        .loading-spinner { border: 4px solid rgba(59, 130, 246, 0.1); border-left-color: #3b82f6; border-radius: 50%; width: 3rem; height: 3rem; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Admin Dashboard Improvements */
        .admin-layout { display: flex; min-height: 100vh; background-color: #f1f5f9; padding-bottom: 0; }
        .admin-sidebar { width: 260px; background: #0f172a; color: #e2e8f0; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
        .admin-content { margin-left: 260px; padding: 2rem; width: calc(100% - 260px); }
        
        .admin-stat-card {
            background: white; border-radius: 1rem; padding: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .admin-stat-card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 80px; height: 80px;
            background: linear-gradient(135deg, transparent 50%, rgba(59, 130, 246, 0.05) 50%);
            border-radius: 0 0 0 100%;
        }
        .stat-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.8; }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: #0f172a; letter-spacing: -0.05em; line-height: 1; margin-top: 0.5rem; }
        .stat-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Mobile Nav (Updated) */
        .mobile-bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px);
            border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between;
            padding: 0.75rem 1rem 1.75rem 1rem; z-index: 100;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
        }
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: 700; color: #94a3b8; gap: 0.3rem; width: 18%; transition: all 0.3s;
        }
        .mobile-nav-item.active { color: #3b82f6; transform: translateY(-2px); }
        .mobile-nav-item i { font-size: 1.25rem; transition: all 0.3s; }
        .mobile-nav-item.active i { transform: scale(1.1); filter: drop-shadow(0 4px 6px rgba(59, 130, 246, 0.4)); }

        .admin-nav-item { padding: 1rem 1.5rem; display: flex; items-center; gap: 0.75rem; color: #94a3b8; font-weight: 600; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
        .admin-nav-item:hover { background: #1e293b; color: #fff; }
        .admin-nav-item.active { background: #1e293b; color: #60a5fa; border-left-color: #60a5fa; }
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; }
        .admin-table th { background: #f8fafc; padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 800; color: #475569; text-transform: uppercase; }
        .admin-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        
        @media (max-width: 768px) {
            .admin-sidebar { display: none; }
            .admin-content { margin-left: 0; padding: 1rem; width: 100%; padding-bottom: 120px; }
            .admin-table { display: none; }
            .mobile-admin-card { background: white; padding: 1.25rem; border-radius: 1rem; border: 1px solid #e2e8f0; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        }
        
        .toast-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(15, 23, 42, 0.95); color: white; padding: 1rem 1.5rem; border-radius: 99px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; backdrop-filter: blur(8px); }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .section-heading { font-size: 2.5rem; font-weight: 900; color: #0f172a; margin-bottom: 2rem; text-align: center; letter-spacing: -0.04em; }
        
        /* Feature & Step Cards */
        .feature-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid #f1f5f9; border-radius: 1.5rem; padding: 2rem;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); transition: all 0.3s;
            text-align: center; height: 100%;
        }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.15); border-color: #bfdbfe; }
        .feature-icon { font-size: 2.5rem; background: -webkit-linear-gradient(45deg, #2563eb, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
        
        .step-container { display: flex; flex-direction: column; gap: 2rem; position: relative; }
        @media(min-width: 768px) { .step-container { flex-direction: row; gap: 1rem; } }
        .step-card { flex: 1; background: white; border-radius: 1rem; padding: 2rem; position: relative; border: 1px solid #e2e8f0; z-index: 10; }
        .step-number { 
            position: absolute; top: -1.5rem; left: 1.5rem; width: 3rem; height: 3rem; 
            background: #0f172a; color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 900; font-size: 1.2rem; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2);
        }
        .step-arrow { display: none; position: absolute; top: 50%; right: -1rem; transform: translateY(-50%); font-size: 1.5rem; color: #cbd5e1; z-index: 5; }
        @media(min-width: 768px) { .step-arrow { display: block; } .step-container > div:last-child .step-arrow { display: none; } }

        /* Social Share Buttons */
        .share-button {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
            font-weight: 700; font-size: 0.9rem; gap: 0.5rem; transition: all 0.2s;
            cursor: pointer;
        }
        .share-btn-x { background: #000; color: #fff; }
        .share-btn-x:hover { opacity: 0.8; }
        .share-btn-line { background: #06c755; color: #fff; }
        .share-btn-line:hover { opacity: 0.9; }
        .share-btn-native { background: linear-gradient(135deg, #2563eb, #8b5cf6); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .share-btn-native:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(37, 99, 235, 0.4); }
        .share-btn-copy { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .share-btn-copy:hover { background: #e2e8f0; }
    </style>
</head>
<body>
    <div class="bg-gradient-mesh"></div>
    <div id="root"></div>

    <script type="text/babel">
        // ▼▼▼ Global Config ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBc6n-8U-8SNcM1CcP4r9sKweAhLcWajNc",
            authDomain: "mysupporter-91816.firebaseapp.com",
            projectId: "mysupporter-91816",
            storageBucket: "mysupporter-91816.firebasestorage.app",
            messagingSenderId: "184010562714",
            appId: "1:184010562714:web:fed9dbcf100b83a5c39323"
        };

        const SYSTEM_LINKS = {
            1000: "https://square.link/u/c3o3ou9j",
            3000: "https://square.link/u/3pZLafBq",
            5000: "https://square.link/u/2CROPwzD",
            DEFAULT: "https://square.link/u/5dVAMWIZ"
        };

        let db = null;
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
            }
        } catch(e) { console.error("Firebase Init Failed", e); }

        const { useState, useMemo, useEffect, Component, createContext, useContext } = React;

        // --- UPDATED LEGAL CONTENT (2026/02/05) ---
        const docContent = {
            terms: `【MySUPPORTER 利用規約】\n\n第1条（適用・同意）\n1. 本規約は、Ark inc.（以下「当社」）が提供する「MySUPPORTER」（以下「本サービス」）の利用条件を定めるものです。\n2. ユーザーは、本サービスを利用することにより、本規約の全ての条項に同意したものとみなされます。\n\n第2条（サービスの本質）\n本サービスは、チームへの物品支援を目的としたクラウドファンディング型プラットフォームです。サポーターからの資金は「寄付」ではなく、当社に対する「物品購入および配送業務の委託費用」として取り扱われます。\n\n第3条（決済および返金不可）\n1. 決済完了をもって、サポーターと当社の間で業務委託契約が成立します。\n2. サービスの性質上、決済完了後のサポーター都合によるキャンセル、返金、支援金額の変更は、いかなる理由（入力ミス、心変わり、チームの活動状況変化等を含む）があっても一切応じられません。\n3. 当社は、チームへの物品提供が完了した時点で、その業務を完遂したものとみなします。\n\n第4条（手数料・残余金）\n支援金には、物品代金、配送費に加え、システム利用料および決済手数料が含まれます。余剰金が発生した場合、それは当社の運営手数料として充当され、サポーターへの返還は行われません。\n\n第5条（免責事項の強化）\n1. 当社は、システム障害、通信回線の不具合、第三者による不正アクセス、天災地変等により本サービスの提供が中断・停止した場合でも、それによりユーザーに生じた損害について一切の責任を負いません。\n2. チームの解散、活動休止、連絡不通等により物品の提供が困難となった場合、当社は代替支援等の措置を講じることがありますが、支援金の返金義務は負わないものとします。\n3. いかなる場合においても、当社の損害賠償責任は、当該ユーザーが過去1ヶ月間に支払った支援総額を上限とします。\n\n第6条（権利の帰属）\n本サービスに投稿された文章、画像、動画等のコンテンツに関する著作権は投稿者に帰属しますが、当社はこれらを本サービスの宣伝、運営、改善のために、無償かつ無期限に自由に利用（複製、編集、公開等）できるものとします。\n\n第7条（禁止事項・解除）\n当社は、ユーザーが本規約に違反した場合、または不適切と判断した場合、事前の通知なく利用停止、登録抹消、法的措置を講じることができます。\n\n第8条（管轄）\n本サービスに関する紛争は、東京地方裁判所を第一審の専属的合意管轄裁判所とします。\n\n2026年2月5日 最新改定`,
            privacy: `【プライバシーポリシー】\n\nArk inc.（以下「当社」）は、個人情報を以下の通り厳格に管理します。\n\n1. 取得情報\n氏名、住所、電話番号、メールアドレス、支援履歴、アクセスログ等。\n※クレジットカード情報は決済代行会社が管理し、当社サーバーでは保持しません。\n\n2. 利用目的\n- 支援物品の配送および連絡\n- サービス運営およびセキュリティ維持\n- 統計データの作成およびマーケティング\n- 法的義務の履行\n\n3. 第三者提供\n法令に基づく場合、または業務委託先（配送会社等）への提供を除き、同意なく第三者に提供しません。\n\n4. 免責\nハッカー等の不正アクセスにより情報が漏洩した場合、当社はセキュリティ対策を講じていた限りにおいて免責されるものとします。\n\n2026年2月5日 最新改定`,
            tokusho: `【特定商取引法に基づく表記】\n\n■事業者名\nArk inc.\n\n■代表者\n茂住 雄太\n\n■所在地\n東京都（特定商取引法に基づき、請求があり次第遅滞なく開示します）\n\n■お問い合わせ\ninfo@mysupporter.jp\n\n■販売価格\n各プロジェクトページに表示（税込）\n\n■商品代金以外の費用\nなし（送料・手数料込）\n\n■支払方法\nクレジットカード決済\n\n■提供時期\nプロジェクト終了後、速やかに物品を手配・配送（通常1〜2ヶ月）\n\n■キャンセル特約\n【返金不可】\n本サービスは寄付的性質を持つクラウドファンディングであり、決済完了後のお客様都合によるキャンセル・返金は一切お受けできません。\n\n■不良品対応\n配送された物品に重大な欠陥がある場合に限り、チーム代表者からの連絡に基づき交換対応を行います（到着後7日以内）。`
        };

        const SafeImage = ({ src, alt, className, fallbackIcon = "fa-image" }) => {
            const [error, setError] = useState(false);
            useEffect(() => { setError(false); }, [src]);
            if (!src || error) return <div className={`${className} flex items-center justify-center bg-slate-100 text-slate-300`}><i className={`fa-solid ${fallbackIcon} text-2xl`}></i></div>;
            return <img src={src} alt={alt} className={className} onError={()=>setError(true)} referrerPolicy="no-referrer" />;
        };

        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'success') => { const id = Date.now(); setToasts(p => [...p, { id, msg, type }]); setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 4000); };
            return (<ToastContext.Provider value={addToast}>{children}<div className="toast-container">{toasts.map(t => (<div key={t.id} className="toast"><i className={`fa-solid ${t.type==='success'?'fa-circle-check text-blue-400':'fa-circle-exclamation text-red-400'} text-xl`}></i><span>{t.msg}</span></div>))}</div></ToastContext.Provider>);
        };
        const useToast = () => useContext(ToastContext);

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { if(this.state.hasError) return <div className="p-10 text-center">システムエラーが発生しました。リロードしてください。</div>; return this.props.children; }
        }

        // ▼▼▼ ROBUST NUMBER PARSER ▼▼▼
        const safeInt = (v) => {
            if (v === null || v === undefined) return 0;
            if (typeof v === 'number') return Math.floor(v);
            const str = String(v).replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/,/g, '').replace(/[^0-9-]/g, '');
            const n = parseInt(str, 10);
            return isNaN(n) ? 0 : n;
        };
        const safeStr = (v) => v || "";
        const formatYen = (v) => "¥" + safeInt(v).toLocaleString();
        
        const calcTargetFunc = (price, shipping, fee) => {
            const p = safeInt(price);
            const s = safeInt(shipping);
            const f = parseFloat(fee) || 1.1;
            if (p === 0) return 9999999; 
            return Math.floor((p + s) * f);
        };

        const ProgressBar = ({ current, target }) => {
            const t = safeInt(target) || 1;
            const c = safeInt(current);
            const percent = Math.min((c / t) * 100, 100);
            return (<div className="w-full mt-3"><div className="flex justify-between items-end mb-1"><span className="text-xs font-black text-blue-600">{Math.floor(percent)}%</span><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">目標: {formatYen(t)}</span></div><div className="meter-bg"><div className={`meter-fill ${percent >= 100 ? 'goal-reached' : ''}`} style={{ width: `${percent}%` }}></div></div></div>);
        };

        const handleImageUpload = (e, cb) => {
            const file = e.target.files[0]; if(!file)return;
            const reader = new FileReader();
            reader.onload = (re) => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); let w=img.width, h=img.height; const MAX=800; if(w>h){if(w>MAX){h*=MAX/w;w=MAX;}}else{if(h>MAX){w*=MAX/h;h=MAX;}} c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); cb(c.toDataURL('image/jpeg',0.8)); }; img.src = re.target.result; }; 
            reader.readAsDataURL(file);
        };

        // --- Admin Dashboard ---
        const AdminDashboard = ({ campaigns, requests, reports, stats, db, systemConfig, onLogout }) => {
            const [tab, setTab] = useState('dashboard');
            const [search, setSearch] = useState('');
            const [editingCampaign, setEditingCampaign] = useState(null);
            const [editingReport, setEditingReport] = useState(null);
            const [isCreatingReport, setIsCreatingReport] = useState(false);
            const [newReport, setNewReport] = useState({ teamId: "", title: "", content: "", image: "" });
            const [configForm, setConfigForm] = useState(systemConfig);
            const toast = useToast();

            const activeList = campaigns.filter(c => c.status !== 'deleted');
            const trashList = campaigns.filter(c => c.status === 'deleted');
            const filteredList = useMemo(() => activeList.filter(c => safeStr(c.team).includes(search) || safeStr(c.name).includes(search)).sort((a,b) => (b.approvedAt||"").localeCompare(a.approvedAt||"")), [activeList, search]);

            const trash = async (id) => { if(!confirm("ゴミ箱へ移動しますか？")) return; await db.collection('campaigns').doc(id).update({status: 'deleted'}); toast("移動しました"); };
            const update = async (id, data) => { await db.collection('campaigns').doc(id).update(data); toast("更新しました"); };
            const restore = async (id) => { update(id, {status:'active'}); };
            const del = async (id) => { if(confirm("【警告】完全に削除しますか？\n復元できません。")) { await db.collection('campaigns').doc(id).delete(); toast("完全に削除しました"); }};
            const deleteReport = async (id) => { if(confirm("削除しますか？")) { await db.collection('reports').doc(id).delete(); toast("削除しました"); }};
            
            const toggleShipping = async (c) => {
                const newStatus = c.shippingStatus === 'shipped' ? 'pending' : 'shipped';
                await db.collection('campaigns').doc(c.id).update({ shippingStatus: newStatus });
                toast(`ステータス変更: ${newStatus}`);
            };

            const copyAddress = (c) => {
                const text = `〒${c.zipCode}\n${c.address}\n${c.contactName} 様\nTel: ${c.phone}`;
                navigator.clipboard.writeText(text);
                toast("住所をコピーしました", "success");
            };

            const saveDetailEdit = async () => {
                if(!editingCampaign) return;
                await db.collection(editingCampaign.status === 'pending' ? 'requests' : 'campaigns').doc(editingCampaign.id).update(editingCampaign);
                toast("保存しました"); setEditingCampaign(null);
            };

            const createReport = async () => { if(!newReport.teamId) return alert("チームを選択してください"); const teamData = campaigns.find(c => c.id === newReport.teamId); await db.collection("reports").add({ ...newReport, team: teamData ? teamData.team : "Unknown", date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString() }); toast("レポート公開完了"); setIsCreatingReport(false); setNewReport({ teamId: "", title: "", content: "", image: "" }); };
            
            const approve = async (req) => {
                if(!req.estimatedPrice) return alert("金額を入力してください");
                const { id, ...data } = req;
                await db.collection("campaigns").add({ ...data, price: safeInt(req.estimatedPrice), current: 0, supporters: 0, status: 'active', approvedAt: new Date().toISOString(), shippingStatus: 'pending', zipCode: data.zipCode || "", address: data.address || "", phone: data.phone || "", contactName: data.contactName || "" });
                await db.collection("requests").doc(req.id).delete(); 
                toast("承認完了");
            };

            const exportCSV = () => {
                const header = ["ID","Team","Item","Status","Current","Target","Shipping","Zip","Address","Phone","Contact"];
                const rows = activeList.map(c => [c.id, c.team, c.name, c.status, c.current, calcTargetFunc(c.price, systemConfig.shippingFee, systemConfig.feeRate), c.shippingStatus||'pending', c.zipCode||'', c.address||'', c.phone||'', c.contactName||'']);
                const csv = "\uFEFF" + [header.join(","), ...rows.map(r=>r.map(v=>`"${safeStr(v).replace(/"/g, '""')}"`).join(","))].join("\n");
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
                link.download = `mysupporter_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            return (
                <div className="admin-layout">
                    <aside className="admin-sidebar">
                        <div className="p-6 border-b border-slate-700 bg-slate-900"><h2 className="font-black text-xl italic text-white tracking-widest">ADMIN</h2></div>
                        <nav className="flex-1 py-6 space-y-1">
                            {['dashboard','campaigns','requests','reports','trash','settings'].map(t => (
                                <div key={t} onClick={()=>setTab(t)} className={`admin-nav-item ${tab===t?'active':''}`}>
                                    <i className={`fa-solid ${t==='dashboard'?'fa-chart-pie':t==='campaigns'?'fa-list-ul':t==='requests'?'fa-envelope-open-text':t==='reports'?'fa-newspaper':t==='trash'?'fa-trash-can':'fa-gear'} w-5`}></i>
                                    <span className="capitalize">{t==='dashboard'?'ホーム':t==='campaigns'?'案件管理':t==='requests'?'申請承認':t==='reports'?'活動報告':t==='trash'?'ゴミ箱':'設定'}</span>
                                    {t==='requests'&&requests.length>0&&<span className="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">{requests.length}</span>}
                                </div>
                            ))}
                        </nav>
                        <div className="p-6 border-t border-slate-700"><button onClick={onLogout} className="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded text-xs font-bold transition">ログアウト</button></div>
                    </aside>
                    <div className="mobile-bottom-nav md:hidden">
                        {['dashboard','campaigns','requests','settings'].map(t=>(
                            <div key={t} onClick={()=>setTab(t)} className={`mobile-nav-item ${tab===t?'active':''}`}>
                                <i className={`fa-solid ${t==='dashboard'?'fa-chart-pie':t==='campaigns'?'fa-list-ul':t==='requests'?'fa-envelope-open-text':'fa-gear'}`}></i>
                                <span className="capitalize">{t==='dashboard'?'ホーム':t==='campaigns'?'案件':t==='requests'?'申請':'設定'}</span>
                            </div>
                        ))}
                    </div>
                    
                    <main className="admin-content">
                        {tab === 'dashboard' && (
                            <div className="space-y-8 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">ダッシュボード</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="admin-stat-card border-l-4 border-blue-500">
                                        <div className="stat-icon text-blue-500"><i className="fa-solid fa-sack-dollar"></i></div>
                                        <div><p className="stat-label">支援総額</p><p className="stat-value">{formatYen(stats.totalPayment)}</p></div>
                                    </div>
                                    <div className="admin-stat-card border-l-4 border-green-500">
                                        <div className="stat-icon text-green-500"><i className="fa-solid fa-flag-checkered"></i></div>
                                        <div><p className="stat-label">実施中プロジェクト</p><p className="stat-value">{stats.activeCount} <span className="text-base text-slate-400 font-medium">件</span></p></div>
                                    </div>
                                    <div className="admin-stat-card border-l-4 border-red-500 cursor-pointer hover:bg-red-50 transition" onClick={()=>setTab('requests')}>
                                        <div className="stat-icon text-red-500"><i className="fa-solid fa-bell"></i></div>
                                        <div><p className="stat-label">承認待ちアクション</p><p className="stat-value text-red-600">{requests.length} <span className="text-base text-slate-400 font-medium">件</span></p></div>
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <h3 className="font-bold text-slate-700 mb-4 border-b pb-2">要対応タスク (ToDo)</h3>
                                    {requests.length === 0 && activeList.filter(c=>c.shippingStatus==='pending' && safeInt(c.current)>=calcTargetFunc(c.price, systemConfig.shippingFee, systemConfig.feeRate)).length === 0 && 
                                        <div className="text-center py-8 text-slate-400 font-bold"><i className="fa-solid fa-check-circle mr-2"></i>現在、対応が必要なタスクはありません</div>
                                    }
                                    <div className="space-y-3">
                                        {requests.map(r => <div key={r.id} onClick={()=>setTab('requests')} className="flex items-center justify-between p-4 bg-red-50 border border-red-100 rounded-xl cursor-pointer hover:bg-red-100 transition"><span className="font-bold text-red-700"><i className="fa-solid fa-circle-exclamation mr-2"></i>新規申請: {r.team}</span><i className="fa-solid fa-angle-right text-red-400"></i></div>)}
                                        {activeList.filter(c => c.shippingStatus === 'pending' && safeInt(c.current) >= calcTargetFunc(c.price, systemConfig.shippingFee, systemConfig.feeRate)).map(c => 
                                            <div key={c.id} onClick={()=>{setTab('campaigns'); setSearch(c.team);}} className="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-100 rounded-xl cursor-pointer hover:bg-yellow-100 transition">
                                                <span className="font-bold text-yellow-700"><i className="fa-solid fa-truck-fast mr-2"></i>未発送 (目標達成): {c.team}</span>
                                                <i className="fa-solid fa-angle-right text-yellow-400"></i>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'campaigns' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">プロジェクト管理</h2><button onClick={exportCSV} className="bg-slate-700 text-white px-4 py-2 rounded text-xs font-bold hover:bg-slate-800 transition"><i className="fa-solid fa-file-csv mr-1"></i> CSV出力</button></div>
                                <input className="input-field mb-4" placeholder="検索（チーム名、担当者名）..." value={search} onChange={e=>setSearch(e.target.value)} />
                                <div className="hidden md:block bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold border-b border-slate-200"><tr><th className="p-4">状態</th><th className="p-4">チーム名</th><th className="p-4">進捗状況</th><th className="p-4">配送ステータス</th><th className="p-4 text-right">操作</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{filteredList.map(c => {
                                            const target = calcTargetFunc(c.price, systemConfig.shippingFee, systemConfig.feeRate);
                                            const isGoal = safeInt(c.current) >= target;
                                            return (
                                                <tr key={c.id} className="hover:bg-slate-50 transition">
                                                    <td className="p-4">{isGoal ? <span className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold">達成</span> : <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">募集中</span>}</td>
                                                    <td className="p-4"><div className="font-bold text-slate-800">{c.team}</div><div className="text-xs text-slate-400">{c.contactName}</div></td>
                                                    <td className="p-4 w-1/3"><ProgressBar current={c.current} target={target}/></td>
                                                    <td className="p-4"><button onClick={()=>toggleShipping(c)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${c.shippingStatus==='shipped'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{c.shippingStatus==='shipped'?'発送済':'未発送'}</button></td>
                                                    <td className="p-4 text-right">
                                                        <button onClick={()=>setEditingCampaign({...c})} className="text-slate-400 hover:text-blue-600 mr-3"><i className="fa-solid fa-pen"></i></button>
                                                        <button onClick={()=>trash(c.id)} className="text-slate-400 hover:text-red-500"><i className="fa-solid fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                            );
                                        })}</tbody>
                                    </table>
                                </div>
                                <div className="md:hidden space-y-4">{filteredList.map(c=><div key={c.id} className="mobile-admin-card"><div className="flex justify-between mb-2"><span className="font-bold">{c.team}</span><button onClick={()=>toggleShipping(c)} className={`text-xs px-3 py-1 rounded-full font-bold ${c.shippingStatus==='shipped'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{c.shippingStatus==='shipped'?'発送済':'未発送'}</button></div><ProgressBar current={c.current} target={calcTargetFunc(c.price, systemConfig.shippingFee, systemConfig.feeRate)}/><div className="mt-4 flex justify-end gap-3"><button onClick={()=>setEditingCampaign({...c})} className="text-sm bg-slate-100 px-4 py-2 rounded font-bold text-slate-600">編集</button><button onClick={()=>trash(c.id)} className="text-sm bg-red-50 text-red-600 px-4 py-2 rounded font-bold">ゴミ箱</button></div></div>)}</div>
                            </div>
                        )}
                        
                        {/* Edit Modal (Admin) */}
                        {editingCampaign && (
                            <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 fade-in">
                                <div className="bg-white w-full max-w-lg rounded-t-2xl md:rounded-2xl shadow-2xl p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                    <div className="flex justify-between items-center border-b pb-4"><h3 className="font-bold text-lg">編集: {editingCampaign.team}</h3><button onClick={()=>setEditingCampaign(null)} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i className="fa-solid fa-xmark"></i></button></div>
                                    <div className="bg-blue-50/50 border border-blue-100 rounded-lg p-4 space-y-3">
                                        <div className="flex justify-between items-center"><h4 className="text-xs font-bold text-blue-800 uppercase"><i className="fa-solid fa-truck-fast mr-1"></i> 配送先情報</h4><button onClick={()=>copyAddress(editingCampaign)} className="text-[10px] bg-white border border-blue-200 px-3 py-1 rounded text-blue-600 font-bold hover:bg-blue-50">コピー</button></div>
                                        <div className="text-sm space-y-1 font-medium text-slate-700">
                                            <div>〒{editingCampaign.zipCode}</div>
                                            <div>{editingCampaign.address}</div>
                                            <div>{editingCampaign.contactName} 様 ({editingCampaign.phone})</div>
                                        </div>
                                    </div>
                                    <div className="space-y-4 pt-2">
                                        {editingCampaign.status !== 'pending' && (
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="text-[10px] font-bold text-slate-500 block mb-1">現在の支援額</label><input type="number" className="input-field font-bold text-blue-600" value={editingCampaign.current} onChange={e=>setEditingCampaign({...editingCampaign, current: safeInt(e.target.value)})}/></div>
                                                <div><label className="text-[10px] font-bold text-slate-500 block mb-1">支援者数</label><input type="number" className="input-field font-bold text-blue-600" value={editingCampaign.supporters} onChange={e=>setEditingCampaign({...editingCampaign, supporters: safeInt(e.target.value)})}/></div>
                                            </div>
                                        )}
                                        <div><label className="text-[10px] font-bold text-slate-500 block mb-1">目標金額設定</label><input type="number" className="input-field" value={editingCampaign.price||editingCampaign.estimatedPrice} onChange={e=>setEditingCampaign({...editingCampaign, [editingCampaign.status==='pending'?'estimatedPrice':'price']: safeInt(e.target.value)})} /></div>
                                        <div><label className="text-[10px] font-bold text-slate-500 block mb-1">Square決済URL</label><input className="input-field" value={editingCampaign.paymentUrl||""} onChange={e=>setEditingCampaign({...editingCampaign, paymentUrl:e.target.value})} placeholder="https://..." /></div>
                                        <div><label className="text-[10px] font-bold text-slate-500 block mb-1">チーム画像</label><input type="file" onChange={e=>handleImageUpload(e, d=>setEditingCampaign({...editingCampaign, teamImage:d}))} className="text-sm" /></div>
                                    </div>
                                    <div className="flex gap-3 pt-6 border-t"><button onClick={()=>setEditingCampaign(null)} className="flex-1 py-3 rounded-lg font-bold text-slate-500 bg-slate-100 hover:bg-slate-200">キャンセル</button><button onClick={saveDetailEdit} className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg">保存</button></div>
                                </div>
                            </div>
                        )}
                        
                        {tab === 'requests' && <div className="fade-in"><h2 className="text-2xl font-bold text-slate-800 mb-6">承認待ち一覧</h2>{requests.length===0 && <div className="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">現在、新しい申請はありません</div>}{requests.map(r=><div key={r.id} className="mobile-admin-card flex flex-col gap-3"><div><span className="font-bold text-lg text-slate-800">{r.team}</span><div className="text-sm text-slate-500 mt-1"><i className="fa-solid fa-user mr-1"></i> {r.contactName} <span className="mx-2">|</span> <i className="fa-solid fa-envelope mr-1"></i> {r.email}</div></div><div className="flex gap-2"><button onClick={()=>setEditingCampaign({...r})} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-200 transition">詳細確認</button><button onClick={()=>approve(r)} className="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition">承認する</button></div></div>)}</div>}
                        {tab === 'reports' && <div className="fade-in"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-slate-800">活動報告管理</h2><button onClick={()=>setIsCreatingReport(true)} className="bg-blue-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition"><i className="fa-solid fa-plus mr-1"></i> 新規作成</button></div>{isCreatingReport && <div className="bg-white rounded-xl border border-slate-200 p-6 mb-6 animate-pulse"><h3 className="font-bold mb-4">新規レポート作成</h3><select className="input-field mb-3" onChange={e=>setNewReport({...newReport, teamId:e.target.value})}><option>チームを選択...</option>{activeList.map(c=><option key={c.id} value={c.id}>{c.team}</option>)}</select><input className="input-field mb-3" placeholder="タイトル" onChange={e=>setNewReport({...newReport, title:e.target.value})}/><textarea className="input-field h-32 mb-3" placeholder="本文" onChange={e=>setNewReport({...newReport, content:e.target.value})}/><input type="file" onChange={e=>handleImageUpload(e, d=>setNewReport({...newReport, image:d}))}/><div className="flex justify-end gap-2 mt-4"><button onClick={()=>setIsCreatingReport(false)} className="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 rounded">キャンセル</button><button onClick={createReport} className="bg-blue-600 text-white font-bold px-6 py-2 rounded hover:bg-blue-700 shadow">公開する</button></div></div>}{reports.map(r=><div key={r.id} className="mobile-admin-card flex justify-between items-center"><div><span className="font-bold">{r.title}</span><br/><span className="text-xs text-slate-400">{r.date} - {r.team}</span></div><div className="flex gap-2"><button onClick={()=>setEditingReport({...r})} className="text-slate-400 hover:text-blue-500 px-2"><i className="fa-solid fa-pen"></i></button><button onClick={()=>deleteReport(r.id)} className="text-slate-400 hover:text-red-500 px-2"><i className="fa-solid fa-trash"></i></button></div></div>)}</div>}
                        {editingReport && <div className="fixed inset-0 z-[60] bg-black/60 flex items-center justify-center p-4"><div className="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl"><h3 className="font-bold mb-4">レポート編集</h3><input className="input-field mb-3" value={editingReport.title} onChange={e=>setEditingReport({...editingReport, title:e.target.value})}/><textarea className="input-field h-32 mb-3" value={editingReport.content} onChange={e=>setEditingReport({...editingReport, content:e.target.value})}/><div className="flex justify-end gap-2"><button onClick={()=>setEditingReport(null)} className="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 rounded">キャンセル</button><button onClick={updateReport} className="bg-blue-600 text-white font-bold px-6 py-2 rounded hover:bg-blue-700">保存</button></div></div></div>}
                        {tab === 'settings' && <div className="fade-in"><h2 className="text-2xl font-bold text-slate-800 mb-6">システム設定</h2><div className="mobile-admin-card"><div className="grid grid-cols-2 gap-6 mb-6"><div><label className="text-sm font-bold text-slate-600 block mb-2">一律送料 (円)</label><input type="number" className="input-field" value={configForm.shippingFee} onChange={e=>setConfigForm({...configForm, shippingFee:safeInt(e.target.value)})}/></div><div><label className="text-sm font-bold text-slate-600 block mb-2">システム手数料係数 (例: 1.1)</label><input type="number" step="0.01" className="input-field" value={configForm.feeRate} onChange={e=>setConfigForm({...configForm, feeRate:parseFloat(e.target.value)})}/></div></div><button onClick={()=>db.collection("config").doc("main").set(configForm).then(()=>toast("設定を保存しました"))} className="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition shadow-lg">設定を保存</button></div></div>}
                        {tab === 'trash' && <div className="fade-in"><h2 className="text-2xl font-bold text-slate-800 mb-6">ゴミ箱 (Deleted)</h2>{trashList.length===0 && <div className="text-center py-12 text-slate-400">ゴミ箱は空です</div>}{trashList.map(c=><div key={c.id} className="mobile-admin-card flex justify-between items-center opacity-75 hover:opacity-100"><div><span className="font-bold">{c.team}</span></div><div className="flex gap-2"><button onClick={()=>restore(c.id)} className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">復元</button><button onClick={()=>del(c.id)} className="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200">完全削除</button></div></div>)}</div>}
                    </main>
                </div>
            );
        };

        // --- Main App ---
        const MainApp = () => {
            const [view, setView] = useState('home');
            const [activeTab, setActiveTab] = useState('top');
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [data, setData] = useState({ campaigns: [], requests: [], reports: [], config: null });
            const [loading, setLoading] = useState(true);
            const [showLogin, setShowLogin] = useState(false);
            const [loginCreds, setLoginCreds] = useState({email:"", pass:""});
            const [selectedCampaign, setSelectedCampaign] = useState(null);
            const [payStep, setPayStep] = useState(1);
            const [amount, setAmount] = useState(0);
            const [entry, setEntry] = useState({ team: "", email: "", itemUrl: "", contactName: "", teamImage: "", description: "", zipCode: "", address: "", phone: "" });
            const [detailModal, setDetailModal] = useState(null);
            const [paymentProcess, setPaymentProcess] = useState(null); 
            const [modal, setModal] = useState({open:false, title:"", content:""});
            const [agreed, setAgreed] = useState(false);
            const toast = useToast();

            // Safety Loading Timeout
            useEffect(() => {
                const timer = setTimeout(() => { if(loading) setLoading(false); }, 3000);
                return () => clearTimeout(timer);
            }, [loading]);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const isAuth = sessionStorage.getItem('adminAuth');
                if(isAuth) setIsAdminMode(true);
                const unsubC = db.collection("campaigns").onSnapshot(s => setData(p => ({...p, campaigns: s.docs.map(d=>({...d.data(), id:d.id}))})));
                const unsubR = db.collection("requests").onSnapshot(s => setData(p => ({...p, requests: s.docs.map(d=>({...d.data(), id:d.id}))})));
                const unsubRep = db.collection("reports").onSnapshot(s => setData(p => ({...p, reports: s.docs.map(d=>({...d.data(), id:d.id}))})));
                const unsubCfg = db.collection("config").doc("main").onSnapshot(d => {
                    if(d.exists) setData(p => ({...p, config: d.data()}));
                    else { const def={shippingFee:500, feeRate:1.1}; db.collection("config").doc("main").set(def); setData(p=>({...p, config:def})); }
                    setLoading(false);
                });

                const pending = sessionStorage.getItem('payment_pending');
                if (pending && data.campaigns.length > 0) {
                    try {
                        const { id, amount } = JSON.parse(pending);
                        const target = data.campaigns.find(c => c.id === id);
                        if (target) {
                            setSelectedCampaign(target);
                            setAmount(amount);
                            setPaymentProcess('reporting');
                            setPayStep(2);
                        }
                    } catch(e) {}
                }
                
                // Permalink Logic
                const hash = window.location.hash;
                if(hash && hash.startsWith('#id=')) {
                    const campaignId = hash.replace('#id=', '');
                    const found = data.campaigns.find(c => c.id === campaignId);
                    if(found) setDetailModal(found);
                }

                return () => { unsubC(); unsubR(); unsubRep(); unsubCfg(); };
            }, [data.campaigns.length]); 

            const login = () => { if(loginCreds.email==="y.moz.fleet@gmail.com" && loginCreds.pass==="Rushers1#") { sessionStorage.setItem('adminAuth', 'true'); window.location.reload(); } else alert("NG"); };
            const logout = () => { sessionStorage.removeItem('adminAuth'); window.location.reload(); };
            
            const submitEntry = async () => { 
                if(!agreed) return; 
                const cleanEntry = {
                    ...entry,
                    phone: entry.phone ? entry.phone.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '') : "",
                    zipCode: entry.zipCode ? entry.zipCode.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '') : ""
                };

                const missing = [];
                if(!cleanEntry.team) missing.push("チーム名");
                if(!cleanEntry.contactName) missing.push("代表者名");
                if(!cleanEntry.email) missing.push("メールアドレス");
                if(!cleanEntry.phone) missing.push("電話番号");
                if(!cleanEntry.zipCode) missing.push("郵便番号");
                if(!cleanEntry.address) missing.push("住所");
                
                if(missing.length > 0) {
                    alert(`以下の項目が未入力です：\n・${missing.join('\n・')}`);
                    return;
                }
                
                await db.collection("requests").add({...cleanEntry, status:'pending', date:new Date().toISOString()}); 
                toast("申請を送信しました！審査をお待ちください。"); 
                setView('home'); 
            };

            const startPayment = () => {
                if(!amount || amount < 100) return alert("100円以上を入力してください");
                let targetUrl = SYSTEM_LINKS.DEFAULT; 
                if (amount === 1000) targetUrl = SYSTEM_LINKS[1000];
                if (amount === 3000) targetUrl = SYSTEM_LINKS[3000];
                if (amount === 5000) targetUrl = SYSTEM_LINKS[5000];
                
                if (targetUrl === SYSTEM_LINKS.DEFAULT) {
                    try { navigator.clipboard.writeText(amount.toString()).catch(()=>{}); } catch(e){}
                    toast("自由入力: 金額をコピーしました", "success");
                } else {
                    toast(`決済画面へ移動します`, "success");
                }
                sessionStorage.setItem('payment_pending', JSON.stringify({ id: selectedCampaign.id, amount: amount }));
                setTimeout(() => { window.location.href = targetUrl; }, 800);
            };

            const finishPayment = async (amt) => {
                try {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    const updatedCampaigns = data.campaigns.map(c => c.id === selectedCampaign.id ? { ...c, current: safeInt(c.current) + safeInt(amt), supporters: safeInt(c.supporters) + 1 } : c);
                    setData(prev => ({ ...prev, campaigns: updatedCampaigns }));
                    await db.collection('campaigns').doc(selectedCampaign.id).update({ current: firebase.firestore.FieldValue.increment(safeInt(amt)), supporters: firebase.firestore.FieldValue.increment(1) });
                    toast("ご支援ありがとうございます！", "success");
                    sessionStorage.removeItem('payment_pending');
                    setPaymentProcess(null);
                    setSelectedCampaign(null);
                    setPayStep(1);
                    setAmount(0);
                } catch(e) { alert("Error: " + e.message); }
            };

            const cancelPayment = () => { sessionStorage.removeItem('payment_pending'); setPaymentProcess(null); };
            
            const handleShare = (campaign) => {
                const shareData = {
                    title: `MySUPPORTER - ${campaign.team}を応援しよう！`,
                    text: `${campaign.team}が${campaign.name}の支援を募集中です。現在の支援額: ¥${campaign.current.toLocaleString()} / 目標: ¥${calcTargetFunc(campaign.price, data.config?.shippingFee, data.config?.feeRate).toLocaleString()}\n#MySUPPORTER #部活動支援`,
                    url: `${window.location.origin}${window.location.pathname}#id=${campaign.id}`
                };

                if (navigator.share) {
                    navigator.share(shareData).catch(console.error);
                } else {
                    // Fallback for PC
                    alert("このブラウザではシェアボタン機能が制限されています。リンクをコピーして共有してください。");
                }
            };
            
            const copyLink = (id) => {
                const url = `${window.location.origin}${window.location.pathname}#id=${id}`;
                navigator.clipboard.writeText(url).then(() => toast("リンクをコピーしました"));
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="loading-spinner"></div></div>;
            if (isAdminMode) return <AdminDashboard campaigns={data.campaigns} requests={data.requests} reports={data.reports} stats={{totalPayment: data.campaigns.reduce((a,c)=>a+safeInt(c.current),0), activeCount:data.campaigns.length}} db={db} systemConfig={data.config||{shippingFee:500, feeRate:1.1}} onLogout={logout} />;

            return (
                <div className="pb-24">
                    <nav className="h-16 flex items-center justify-between px-6 bg-white/90 backdrop-blur fixed top-0 w-full z-40 border-b shadow-sm">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={()=>{setView('home'); setActiveTab('top');}}>
                            <div className="bg-slate-900 text-white w-8 h-8 rounded flex items-center justify-center font-black">S</div>
                            <span className="font-black italic text-xl">MySUPPORTER</span>
                        </div>
                        <div className="hidden md:flex gap-6">
                            {[{k:'top', l:'トップ'},{k:'campaigns', l:'プロジェクト'},{k:'about', l:'サービスについて'},{k:'howitworks', l:'仕組み'},{k:'thanks', l:'活動報告'}].map(m => (
                                <button key={m.k} onClick={()=>{setView('home'); setActiveTab(m.k);}} className={`text-xs font-bold ${activeTab===m.k?'text-blue-600':'text-slate-500'}`}>{m.l}</button>
                            ))}
                        </div>
                        <button onClick={()=>setView('apply')} className="text-xs font-bold border-2 border-slate-900 px-4 py-2 rounded-full hover:bg-slate-900 hover:text-white transition">掲載リクエスト</button>
                    </nav>

                    {/* Mobile Nav User (Optimized) */}
                    <div className="mobile-bottom-nav md:hidden">
                        {[{k:'top',i:'fa-house',l:'ホーム'},{k:'campaigns',i:'fa-flag',l:'支援'},{k:'about',i:'fa-circle-info',l:'概要'},{k:'howitworks',i:'fa-list-ol',l:'仕組み'},{k:'thanks',i:'fa-bullhorn',l:'報告'}].map(m => (
                            <div key={m.k} onClick={()=>{setView('home'); setActiveTab(m.k); window.scrollTo({top:0, behavior:'smooth'})}} className={`mobile-nav-item ${activeTab===m.k?'active':''}`}>
                                <i className={`fa-solid ${m.i}`}></i><span>{m.l}</span>
                            </div>
                        ))}
                    </div>

                    {paymentProcess === 'reporting' && (
                        <div className="fixed inset-0 z-[150] bg-slate-900/95 flex items-center justify-center p-6 text-center fade-in">
                            <div className="max-w-sm w-full space-y-8">
                                <div className="text-white">
                                    <h3 className="text-2xl font-black mb-2">決済完了確認</h3>
                                    <p className="text-sm opacity-70">決済は無事に完了しましたか？<br/>下のボタンを押して、支援を確定させてください。</p>
                                </div>
                                <div className="bg-white/10 p-6 rounded-2xl border border-white/20">
                                    <div className="text-sm text-white/60 mb-1">今回の支援額</div>
                                    <div className="text-4xl font-black text-white">{formatYen(amount)}</div>
                                </div>
                                <button onClick={()=>finishPayment(amount)} className="w-full py-4 bg-blue-500 text-white rounded-xl font-black text-lg shadow-lg hover:bg-blue-400 transition transform hover:scale-105">
                                    支払いを完了しました <i className="fa-solid fa-check ml-2"></i>
                                </button>
                                <button onClick={cancelPayment} className="text-white/40 text-xs font-bold hover:text-white">キャンセル</button>
                            </div>
                        </div>
                    )}

                    {selectedCampaign && !paymentProcess && (
                        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 fade-in">
                            <div className="bg-white w-full max-w-md rounded-t-2xl md:rounded-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b flex justify-between items-center"><span className="font-bold">{selectedCampaign.team}</span><button onClick={()=>setSelectedCampaign(null)} className="p-2"><i className="fa-solid fa-xmark text-xl"></i></button></div>
                                
                                {(() => {
                                    const target = calcTargetFunc(selectedCampaign.price, data.config?.shippingFee, data.config?.feeRate);
                                    const isGoal = safeInt(selectedCampaign.current) >= target;
                                    
                                    return (
                                        <div className="p-6 overflow-y-auto space-y-6 relative">
                                            {isGoal && (
                                                <div className="goal-overlay-cool rounded-xl mb-4">
                                                    <div className="goal-stamp-cool">GOAL ACHIEVED</div>
                                                </div>
                                            )}

                                            {payStep === 1 ? (
                                                <div className={`space-y-4 ${isGoal ? 'opacity-30 pointer-events-none' : ''}`}>
                                                    <p className="text-center font-bold text-sm text-slate-500">支援金額を選んでください</p>
                                                    {(() => {
                                                        const remain = Math.max(0, target - safeInt(selectedCampaign.current));
                                                        return remain > 0 ? (
                                                            <button onClick={()=>{setAmount(remain); setPayStep(2);}} className="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-black rounded-xl shadow-md hover:scale-[1.02] transition mb-4 flex items-center justify-center gap-2">
                                                                残り全額を支援 ({formatYen(remain)}) <i className="fa-solid fa-bolt"></i>
                                                            </button>
                                                        ) : null;
                                                    })()}
                                                    <div className="grid grid-cols-2 gap-3">{[1000,3000,5000,10000].map(a=><button key={a} onClick={()=>{setAmount(a); setPayStep(2);}} className="py-4 border-2 rounded-xl font-bold hover:border-blue-500 hover:text-blue-600 text-lg">¥{a.toLocaleString()}</button>)}</div>
                                                    <input type="number" className="input-field text-center" placeholder="その他金額を入力" onChange={e=>setAmount(safeInt(e.target.value))} />
                                                    {amount>0 && <button onClick={()=>setPayStep(2)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg">次へ進む</button>}
                                                </div>
                                            ) : (
                                                <div className="space-y-6 text-center">
                                                    <div><p className="text-xs text-slate-400 font-bold">支援金額</p><p className="text-4xl font-black text-blue-600">{formatYen(amount)}</p></div>
                                                    <div className="bg-blue-50 p-4 rounded-xl text-left text-xs text-blue-800 leading-relaxed font-bold">
                                                        <i className="fa-solid fa-circle-info mr-1"></i> 確認: ボタンを押すと決済画面へ移動します。<br/>
                                                        <span className="text-blue-600">{amount === 1000 || amount === 3000 || amount === 5000 ? "金額は既に設定されています。" : "自由入力モード: 移動先で金額を入力してください。"}</span>
                                                    </div>
                                                    <button onClick={startPayment} className="w-full py-4 bg-slate-900 text-white rounded-xl font-black shadow-lg hover:bg-black transition flex items-center justify-center gap-2">決済画面へ移動する <i className="fa-solid fa-arrow-up-right-from-square"></i></button>
                                                    <button onClick={()=>setPayStep(1)} className="text-sm text-slate-400 font-bold p-2">戻る</button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto p-4 md:pt-24 space-y-20 pt-20">
                        {view==='home' && (
                            <>
                                {/* Top Hero (Coolest Impact) */}
                                {activeTab === 'top' && (
                                    <div className="min-h-screen flex items-center justify-center -mt-24 fade-in">
                                        <div className="rounded-[2rem] md:rounded-[3rem] overflow-hidden bg-slate-900 text-white w-full h-[85vh] flex items-center relative group shadow-2xl">
                                            <img src="https://images.unsplash.com/photo-1434648957308-5e6a859697e8?q=80&w=2074&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:scale-105 transition duration-[3s]"/>
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/30"></div>
                                            <div className="relative z-10 p-8 md:p-12 max-w-4xl mx-auto text-center">
                                                <h1 className="text-5xl md:text-8xl font-black tracking-tighter mb-6 leading-tight drop-shadow-2xl">勝利を、<br/>共に創る。</h1>
                                                <p className="text-lg md:text-2xl font-bold opacity-90 mb-10 leading-relaxed drop-shadow-lg text-slate-200">部活動の「欲しい」を、みんなの「支援」で現実に。<br/>次世代のアスリートを支える新しいプラットフォーム。</p>
                                                <button onClick={()=>{setActiveTab('campaigns'); window.scrollTo({top:0, behavior:'smooth'})}} className="bg-white text-slate-900 px-10 py-5 rounded-full font-black text-lg hover:bg-blue-50 transition transform hover:scale-105 shadow-2xl border-4 border-transparent hover:border-blue-200">プロジェクトを見る</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Campaigns List */}
                                {activeTab === 'campaigns' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 fade-in">
                                        {data.campaigns.filter(c=>c.status==='active').map(c => {
                                            const target = calcTargetFunc(c.price, data.config?.shippingFee, data.config?.feeRate);
                                            const isGoal = safeInt(c.current) >= target;
                                            return (
                                                <div key={c.id} className="campaign-card h-full">
                                                    <div className="h-56 md:h-64 bg-slate-100 relative overflow-hidden cursor-pointer" onClick={()=>setDetailModal(c)}>
                                                        <SafeImage src={c.teamImage} className="w-full h-full object-cover"/>
                                                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 p-4 pt-16"><h3 className="text-white font-bold text-xl">{c.team}</h3></div>
                                                        {isGoal && <div className="goal-overlay-cool"><div className="goal-stamp-cool">GOAL</div></div>}
                                                    </div>
                                                    <div className="p-5 flex flex-col gap-4 flex-grow">
                                                        <div><span className="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded">希望物品</span><p className="font-bold text-slate-800 mt-1 line-clamp-1">{c.name}</p></div>
                                                        <div><div className="flex justify-between text-xs font-bold text-slate-400 mb-1"><span>{formatYen(c.current)}</span><span>目標: {formatYen(target)}</span></div><ProgressBar current={c.current} target={target}/></div>
                                                        {isGoal ? <button disabled className="mt-auto w-full py-3 bg-gray-200 text-slate-400 rounded-xl font-bold cursor-not-allowed">目標達成済み</button> : <button onClick={()=>{setSelectedCampaign(c); setPayStep(1);}} className="mt-auto w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-blue-600 transition shadow-md">支援する</button>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* Stylish About & How It Works */}
                                {(activeTab === 'about' || activeTab === 'howitworks') && (
                                    <div className="text-center max-w-5xl mx-auto py-12 fade-in">
                                        <h2 className="section-heading">{activeTab==='about'?'MySUPPORTERとは':'支援の仕組み'}</h2>
                                        
                                        {activeTab === 'about' ? (
                                            <div className="grid md:grid-cols-3 gap-8">
                                                {[
                                                    {icon:"fa-users", t:"地域との絆", d:"物理的な距離を超え、母校や地元のチームを直接サポート。あなたの想いが選手の力になります。"},
                                                    {icon:"fa-shirt", t:"透明性のある支援", d:"現金ではなく「チームが必要とする用具」そのものを届けます。使途が明確で安心です。"},
                                                    {icon:"fa-bolt", t:"可能性の最大化", d:"環境による格差をなくし、すべての学生アスリートが全力を出せる未来を創造します。"}
                                                ].map((x,i)=>(
                                                    <div key={i} className="feature-card">
                                                        <div className="feature-icon"><i className={`fa-solid ${x.icon}`}></i></div>
                                                        <h3 className="font-bold text-xl mb-3 text-slate-800">{x.t}</h3>
                                                        <p className="text-sm text-slate-500 leading-relaxed">{x.d}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="step-container max-w-4xl mx-auto text-left mt-8">
                                                {[
                                                    {step:1, t:"チームを探す", d:"応援したい学校や部活動をプロジェクト一覧から見つけます。"},
                                                    {step:2, t:"支援を贈る", d:"クレジットカードで、一口1,000円から手軽に支援金を贈れます。"},
                                                    {step:3, t:"物品が届く", d:"集まった資金で新品の用具を購入し、チームへ寄贈・配送します。"}
                                                ].map((s,k)=>(
                                                    <div key={k} className="step-card">
                                                        <div className="step-number">{s.step}</div>
                                                        <i className="fa-solid fa-chevron-right step-arrow"></i>
                                                        <h3 className="font-bold text-lg mb-2 text-slate-800 mt-2">{s.t}</h3>
                                                        <p className="text-sm text-slate-500">{s.d}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {activeTab === 'thanks' && data.reports.length > 0 && (
                                    <div className="max-w-6xl mx-auto fade-in">
                                        <h2 className="text-3xl font-black text-center mb-8">活動報告</h2>
                                        <div className="grid md:grid-cols-2 gap-6">
                                            {data.reports.map(r=>(
                                                <div key={r.id} className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100 flex flex-col md:flex-row">
                                                    <div className="md:w-48 h-48 bg-slate-100 shrink-0"><SafeImage src={r.image} className="w-full h-full object-cover"/></div>
                                                    <div className="p-6">
                                                        <div className="text-xs font-bold text-blue-500 mb-2">{r.date} - {r.team}</div>
                                                        <h3 className="font-bold text-lg mb-2">{r.title}</h3>
                                                        <p className="text-sm text-slate-500 leading-relaxed whitespace-pre-wrap">{r.content}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                        
                        {view==='apply' && (
                            <div className="max-w-lg mx-auto bg-white p-8 md:p-12 rounded-[2rem] shadow-xl border border-slate-100 space-y-6 fade-in">
                                <h2 className="text-2xl font-black text-center mb-4">チーム掲載申請</h2>
                                <p className="text-center text-sm text-slate-500 mb-6">以下のフォームに入力してください。<br/><span className="text-red-500">*</span> は必須項目です。</p>
                                <div><label className="text-xs font-bold ml-1">チーム名 <span className="text-red-500">*</span></label><input className="input-field" onChange={e=>setEntry({...entry, team:e.target.value})} /></div>
                                <div><label className="text-xs font-bold ml-1">代表者名 <span className="text-red-500">*</span></label><input className="input-field" onChange={e=>setEntry({...entry, contactName:e.target.value})} /></div>
                                <div><label className="text-xs font-bold ml-1">電話番号 <span className="text-red-500">*</span></label><input className="input-field" type="tel" onChange={e=>setEntry({...entry, phone:e.target.value})} /></div>
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="col-span-1"><label className="text-xs font-bold ml-1">郵便番号 <span className="text-red-500">*</span></label><input className="input-field" onChange={e=>setEntry({...entry, zipCode:e.target.value})} /></div>
                                    <div className="col-span-2"><label className="text-xs font-bold ml-1">住所 <span className="text-red-500">*</span></label><input className="input-field" onChange={e=>setEntry({...entry, address:e.target.value})} /></div>
                                </div>
                                <div><label className="text-xs font-bold ml-1">メールアドレス <span className="text-red-500">*</span></label><input className="input-field" type="email" onChange={e=>setEntry({...entry, email:e.target.value})} /></div>
                                <div><label className="text-xs font-bold ml-1">チーム画像</label><input type="file" onChange={e=>handleImageUpload(e, d=>setEntry({...entry, teamImage:d}))} className="w-full text-xs" /></div>
                                <div><label className="text-xs font-bold ml-1">欲しい商品のURL</label><input className="input-field" onChange={e=>setEntry({...entry, itemUrl:e.target.value})} /></div>
                                <div><label className="text-xs font-bold ml-1">想い・ストーリー</label><textarea className="input-field h-32" onChange={e=>setEntry({...entry, description:e.target.value})} /></div>
                                <div className="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="termsCheck" className="w-5 h-5 accent-slate-900 cursor-pointer" onChange={e=>setAgreed(e.target.checked)} />
                                    <label htmlFor="termsCheck" className="text-sm cursor-pointer select-none"><span onClick={()=>setModal({open:true, title:'利用規約', content:docContent.terms})} className="text-blue-600 font-bold hover:underline">利用規約</span> を確認し、同意します</label>
                                </div>
                                <button onClick={submitEntry} className="w-full py-4 bg-slate-900 text-white rounded-xl font-black shadow-lg hover:bg-black transition">申請を送信</button>
                            </div>
                        )}
                    </div>

                    <footer className="md:mt-24 py-12 text-center border-t bg-white mb-16 md:mb-0">
                        <div className="max-w-4xl mx-auto px-6">
                            <div className="mb-8"><span className="font-black italic text-xl text-slate-900">MySUPPORTER</span><p onClick={()=>{if(!isAdminMode)setShowLogin(true)}} className={`text-[10px] font-bold text-slate-400 tracking-widest mt-2 ${!isAdminMode && "cursor-pointer hover:text-slate-600 secret-trigger"}`}>© 2026 MySUPPORTER. All Rights Reserved.</p></div>
                            <div className="flex flex-wrap justify-center gap-4 md:gap-6">
                                <button onClick={()=>setModal({open:true, title:'利用規約', content:docContent.terms})} className="text-[10px] font-bold text-slate-500 hover:text-blue-600">利用規約</button>
                                <button onClick={()=>setModal({open:true, title:'プライバシーポリシー', content:docContent.privacy})} className="text-[10px] font-bold text-slate-500 hover:text-blue-600">プライバシーポリシー</button>
                                <button onClick={()=>setModal({open:true, title:'特商法', content:docContent.tokusho})} className="text-[10px] font-bold text-slate-500 hover:text-blue-600">特商法表記</button>
                                <a href="https://ymozfleet-creator.github.io/Ark/" target="_blank" className="text-[10px] font-bold text-slate-500 hover:text-blue-600">運営会社</a>
                            </div>
                        </div>
                    </footer>

                    {showLogin && <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-6"><div className="bg-white p-8 rounded-2xl w-full max-w-sm space-y-4"><h3 className="font-bold text-center">管理者ログイン</h3><input className="input-field" placeholder="Email" onChange={e=>setLoginCreds({...loginCreds, email:e.target.value})}/><input className="input-field" type="password" placeholder="Pass" onChange={e=>setLoginCreds({...loginCreds, pass:e.target.value})}/><button onClick={login} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">ログイン</button><button onClick={()=>setShowLogin(false)} className="w-full text-center text-xs">キャンセル</button></div></div>}
                    
                    {/* Detail Modal */}
                    {detailModal && (
                        <div className="fixed inset-0 z-[70] bg-slate-900/80 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 fade-in" onClick={()=>setDetailModal(null)}>
                            <div className="bg-white w-full max-w-2xl rounded-t-2xl md:rounded-2xl shadow-2xl relative overflow-hidden flex flex-col max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                                <div className="relative h-56 md:h-64 shrink-0 bg-slate-100">
                                    <SafeImage src={detailModal.teamImage} className="w-full h-full object-cover"/>
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 p-6 flex items-end"><h3 className="text-2xl md:text-3xl font-black text-white">{detailModal.team}</h3></div>
                                    <button onClick={()=>setDetailModal(null)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center"><i className="fa-solid fa-xmark"></i></button>
                                </div>
                                <div className="p-6 md:p-8 overflow-y-auto">
                                    <div className="flex items-center gap-4 mb-6 pb-6 border-b">
                                        <div className="w-16 h-16 bg-slate-100 rounded-xl shrink-0 flex items-center justify-center overflow-hidden border"><SafeImage src={detailModal.image} className="w-full h-full object-contain" fallbackIcon="fa-shirt"/></div>
                                        <div><p className="text-xs font-bold text-blue-500 uppercase">希望物品</p><a href={detailModal.itemUrl||"#"} target="_blank" className="font-bold text-lg text-slate-800 hover:text-blue-600">{detailModal.name} <i className="fa-solid fa-arrow-up-right-from-square text-xs opacity-50"></i></a></div>
                                    </div>
                                    <p className="text-slate-600 leading-loose whitespace-pre-wrap mb-8">{detailModal.description}</p>
                                    
                                    {/* SNS Share Area (New) */}
                                    <div className="bg-slate-50 p-4 rounded-xl mb-6">
                                        <p className="text-center text-xs font-bold text-slate-500 mb-3">このプロジェクトをシェアして応援！</p>
                                        <div className="grid grid-cols-2 gap-3 md:grid-cols-4">
                                            {navigator.share ? (
                                                <button onClick={()=>handleShare(detailModal)} className="share-button share-btn-native col-span-2 md:col-span-4"><i className="fa-solid fa-share-nodes"></i> シェアする</button>
                                            ) : (
                                                <>
                                                    <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(detailModal.team + "を応援しよう！ #MySUPPORTER")}&url=${encodeURIComponent(window.location.origin + window.location.pathname + '#id=' + detailModal.id)}`} target="_blank" rel="noreferrer" className="share-button share-btn-x"><i className="fa-brands fa-x-twitter"></i> Post</a>
                                                    <a href={`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(window.location.origin + window.location.pathname + '#id=' + detailModal.id)}`} target="_blank" rel="noreferrer" className="share-button share-btn-line"><i className="fa-brands fa-line"></i> LINE</a>
                                                    <button onClick={()=>copyLink(detailModal.id)} className="share-button share-btn-copy col-span-2"><i className="fa-regular fa-copy"></i> リンクコピー</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 md:p-6 border-t bg-slate-50"><button onClick={()=>{setSelectedCampaign(detailModal); setDetailModal(null); setPayStep(1);}} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-blue-700 transition">このチームを支援する</button></div>
                            </div>
                        </div>
                    )}

                    {modal.open && <div className="fixed inset-0 z-[110] bg-slate-900/50 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4" onClick={()=>setModal({...modal, open:false})}><div className="bg-white p-6 md:p-8 rounded-t-2xl md:rounded-2xl max-w-2xl max-h-[85vh] overflow-auto shadow-2xl w-full" onClick={e=>e.stopPropagation()}><h3 className="font-bold text-xl mb-4 text-slate-800 border-b pb-2">{modal.title}</h3><pre className="whitespace-pre-wrap text-sm text-slate-600 leading-relaxed font-sans">{modal.content}</pre><button onClick={()=>setModal({...modal, open:false})} className="mt-6 w-full bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition">閉じる</button></div></div>}
                </div>
            );
        };

        const App = () => (<ToastProvider><ErrorBoundary><MainApp /></ErrorBoundary></ToastProvider>);
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
